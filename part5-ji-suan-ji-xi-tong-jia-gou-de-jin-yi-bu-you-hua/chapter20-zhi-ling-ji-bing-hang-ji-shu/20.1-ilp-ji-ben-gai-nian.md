# 20.1 ILP基本概念与简单认识

### ILP基本概念

在本章引言中，我们已经提到ILP实际上是一种**利用指令间潜在并行性进行优化的技术**。最简单的例子便是流水线技术，它将指令的执行分为较短的几个阶段，不同的指令在同一时刻可以处于不同的执行阶段，由此实现了指令级并行。

### 基本块（Basic Block）

请阅读以下代码：

```c
for (int i =0; i <= 999; i++)
    x[i] = x[i] + y[i];
```

相信你能够十分轻松地将这一段代码转化为RISC-V汇编代码。让你的流水线CPU开始执行这些代码，你将会无助地发现，无需几条指令，你的代码便会陷入控制冒险中。这显然不是我们希望看到的，但是很遗憾，对于一般的RISC程序，平均需要分支预测的指令比例通常在15%到25%之间，也就是说，平均约4-7条指令便会遭遇一次控制冒险，这并不是一个好消息。为了更好地描述这一问题，我们引入一个新的概念称为**基本块**。程序中的基本块只有一个入口和一个出口，入口就是其中的第—条语句，出口就是其中的最后一条语句。对一个基本块来说，执行时只从其入口进入，从其出口退出。具体而言：

1. 只有一个入口，表示程序中不会有其它任何地方能通过跳转类指令进入到此基本块中；
2. 只有一个出口，表示程序只有最后一条指令能导致进入到其它基本块去执行。

所以，基本块的一个典型特点是：只要基本块中第一条指令被执行了，那么基本块内所有执行都会按照**顺序**仅**执行一次**。有了基本块的定义后，前述问题可被描述为五个字：基本块太小，由此控制冒险严重。不仅如此，基本块中的指令间数据冒险也常常十分严重，因此严重影响ILP所需的指令间潜在并行性。为了优化这一问题，我们不难想到以下三种途径：

1. 为了降低控制冒险的损失，我们可以使用高级的分支预测技术；
2. 面对冲突严重的情况，我们可以通过硬件动态调度进一步挖掘并行性；
3. 同一基本块内冲突严重，我们可以通过静态调度，使得我们可以在不同的基本块的指令间实现ILP。

对于1，这一内容在Chapter08中已经介绍。对于2和3，我们我们将在之后的章节中详细讲解。

事实上，基本块这一概念不仅在体系结构中会被不断强调，在编译原理、程序分析等领域也是很基本的概念，此处不再展开，只表明其重要性。

### 数据依赖与数据冒险

通过上一小节的例子，

在这一节的最后，我们来完成一个简单的练习以巩固所学的知识：

**练习20.1.1**

阅读以下汇编代码并回答问题，假定代码将运行在无前递（forwarding）机制的顺序执行流水线CPU上，每条指令的理想执行时间均为1个流水线周期：

```nasm
```

1. 请写出上述代码中所有的基本块；
2. 请写出上述代码中所有出现的数据依赖与数据冒险类型，并计算执行上述代码所需的最小周期数；
3. 请写出你解决2中数据冒险的方式，并根据你的方法，计算出解决数据冒险后执行上述代码所需的最小周期数。
